rules_version = '2';

// Firebase Storage Security Rules for Dharma CMS
service firebase.storage {
  match /b/{bucket}/o {
    
    // Helper function to check if user is an approved police officer
    function isPolice() {
      return request.auth != null &&
             firestore.exists(/databases/(default)/documents/police/$(request.auth.uid)) &&
             firestore.get(/databases/(default)/documents/police/$(request.auth.uid)).data.role == 'police' &&
             firestore.get(/databases/(default)/documents/police/$(request.auth.uid)).data.isApproved == true;
    }
    
    // Helper function to check if user owns the case
    function ownsCase(caseId) {
      return request.auth != null &&
             firestore.exists(/databases/(default)/documents/cases/$(caseId)) &&
             firestore.get(/databases/(default)/documents/cases/$(caseId)).data.userId == request.auth.uid;
    }
    
    // -------------------------------------------------------------------------
    //  FIX: Added Missing Rule for Case Journal
    // -------------------------------------------------------------------------
    match /case_journal/{caseId}/{allPaths=**} {
      // Allow police to upload/view journal attachments
      allow read, write: if isPolice();
      
      // Allow citizens to read evidence if they own the case
      allow read: if ownsCase(caseId);
    }
    
    // CRIME SCENE EVIDENCE FILES
    match /crime-scene-evidence/{caseId}/{filename} {
      allow create: if isPolice() && 
                      request.resource.size < 50 * 1024 * 1024 && 
                      (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType.matches('video/.*') ||
                       request.resource.contentType == 'application/pdf');
      allow read: if isPolice() || ownsCase(caseId);
      allow update, delete: if isPolice();
    }
    
    // GEO-TAGGED EVIDENCE
    match /geo-evidence/{caseId}/{filename} {
      allow create: if isPolice() && 
                      request.resource.size < 50 * 1024 * 1024 && 
                      (request.resource.contentType.matches('image/.*') ||
                       request.resource.contentType.matches('video/.*'));
      allow read: if isPolice() || ownsCase(caseId);
      allow update, delete: if isPolice();
    }
    
    // CASE DOCUMENTS
    match /case-documents/{caseId}/{filename} {
      allow create: if (isPolice() || ownsCase(caseId)) && 
                      request.resource.size < 10 * 1024 * 1024;
      allow read: if isPolice() || ownsCase(caseId);
      allow update, delete: if isPolice() || ownsCase(caseId);
    }
    
    // INVESTIGATION REPORTS
    match /investigation-reports/{caseId}/{filename} {
      allow create: if isPolice() && 
                      request.resource.size < 10 * 1024 * 1024 && 
                      request.resource.contentType == 'application/pdf';
      allow read: if isPolice() || ownsCase(caseId);
      allow update, delete: if isPolice();
    }
    
    // PETITION DOCUMENTS
    match /petition-documents/{petitionId}/{filename} {
      allow create: if request.auth != null && 
                      request.resource.size < 10 * 1024 * 1024;
      allow read: if request.auth != null;
      allow update, delete: if request.auth != null;
    }
    
    // PROFILE PICTURES
    match /profile-pictures/{userId}/{filename} {
      allow create: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size < 5 * 1024 * 1024 && 
                      request.resource.contentType.matches('image/.*');
      allow read: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == userId;
    }
    
    // COMPLAINT ATTACHMENTS
    match /complaint-attachments/{complaintId}/{filename} {
      allow create: if request.auth != null && 
                      request.resource.size < 20 * 1024 * 1024;
      allow read: if request.auth != null;
      allow update, delete: if isPolice();
    }
    
    // Default: Deny all other access
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
